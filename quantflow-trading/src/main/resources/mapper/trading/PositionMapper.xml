<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.quantflow.trading.account.mapper.PositionMapper">

    <resultMap type="com.quantflow.trading.account.domain.Position" id="PositionResult">
        <result property="id"                   column="id"    />
        <result property="accountId"            column="account_id"    />
        <result property="symbol"               column="symbol"    />
        <result property="quantity"             column="quantity"    />
        <result property="availableQty"         column="available_qty"    />
        <result property="frozenQty"            column="frozen_qty"    />
        <result property="avgPrice"             column="avg_price"    />
        <result property="currentPrice"         column="current_price"    />
        <result property="marketValue"          column="market_value"    />
        <result property="unrealizedPnl"        column="unrealized_pnl"    />
        <result property="unrealizedPnlRatio"   column="unrealized_pnl_ratio"    />
        <result property="updateTime"           column="update_time"    />
    </resultMap>

    <sql id="selectPositionVo">
        select id, account_id, symbol, quantity, available_qty, frozen_qty, avg_price,
               current_price, market_value, unrealized_pnl, unrealized_pnl_ratio, update_time
        from qf_position
    </sql>

    <select id="selectPositionList" parameterType="com.quantflow.trading.account.domain.Position" resultMap="PositionResult">
        <include refid="selectPositionVo"/>
        <where>
            <if test="accountId != null">
                and account_id = #{accountId}
            </if>
            <if test="symbol != null and symbol != ''">
                and symbol = #{symbol}
            </if>
        </where>
        order by market_value desc
    </select>

    <select id="selectPositionById" parameterType="Long" resultMap="PositionResult">
        <include refid="selectPositionVo"/>
        where id = #{id}
    </select>

    <select id="selectPositionByAccountAndSymbol" resultMap="PositionResult">
        <include refid="selectPositionVo"/>
        where account_id = #{accountId} and symbol = #{symbol}
    </select>

    <insert id="insertPosition" parameterType="com.quantflow.trading.account.domain.Position" useGeneratedKeys="true" keyProperty="id">
        insert into qf_position
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="accountId != null">account_id,</if>
            <if test="symbol != null and symbol != ''">symbol,</if>
            <if test="quantity != null">quantity,</if>
            <if test="availableQty != null">available_qty,</if>
            <if test="frozenQty != null">frozen_qty,</if>
            <if test="avgPrice != null">avg_price,</if>
            <if test="currentPrice != null">current_price,</if>
            <if test="marketValue != null">market_value,</if>
            <if test="unrealizedPnl != null">unrealized_pnl,</if>
            <if test="unrealizedPnlRatio != null">unrealized_pnl_ratio,</if>
            update_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="accountId != null">#{accountId},</if>
            <if test="symbol != null and symbol != ''">#{symbol},</if>
            <if test="quantity != null">#{quantity},</if>
            <if test="availableQty != null">#{availableQty},</if>
            <if test="frozenQty != null">#{frozenQty},</if>
            <if test="avgPrice != null">#{avgPrice},</if>
            <if test="currentPrice != null">#{currentPrice},</if>
            <if test="marketValue != null">#{marketValue},</if>
            <if test="unrealizedPnl != null">#{unrealizedPnl},</if>
            <if test="unrealizedPnlRatio != null">#{unrealizedPnlRatio},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updatePosition" parameterType="com.quantflow.trading.account.domain.Position">
        update qf_position
        <trim prefix="SET" suffixOverrides=",">
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="availableQty != null">available_qty = #{availableQty},</if>
            <if test="frozenQty != null">frozen_qty = #{frozenQty},</if>
            <if test="avgPrice != null">avg_price = #{avgPrice},</if>
            <if test="currentPrice != null">current_price = #{currentPrice},</if>
            <if test="marketValue != null">market_value = #{marketValue},</if>
            <if test="unrealizedPnl != null">unrealized_pnl = #{unrealizedPnl},</if>
            <if test="unrealizedPnlRatio != null">unrealized_pnl_ratio = #{unrealizedPnlRatio},</if>
            update_time = sysdate()
        </trim>
        where id = #{id}
    </update>

    <delete id="deletePositionById" parameterType="Long">
        delete from qf_position where id = #{id}
    </delete>

</mapper>